package uniandes.rebel.chatlogs;

import rebel_chatlogs.Message;
import rebel_chatlogs.MessageLog;

public class CEPopulation {

private CEModel ceModel;
	
	public CEPopulation() {
		ceModel = new CEModel();
	}
	
	/**
	 * Executed by revelapi
	 * @param project
	 * @param commits
	 * @throws Exception
	 */
	public void execute(String project, String chatEmailFileName) throws Exception {		
		
		// Temporal loaded route from web page
		String contentLog =  CEUtil.readFile("/Users/borisperezg/temporaluploadfolder/"+chatEmailFileName);
		
		String type = "chat";
		if(chatEmailFileName.indexOf(".eml")>=0)
			type = "email";
		
		String subject = CEUtil.getValueMatch("Subject:\\s([\\w|\\d|\\s|?|\\[|\\]|:]+)\\n", contentLog);
		
		// La fecha se captura as√≠:
		// "Thu, 4 Mar 2021 14:31:54 "
		String date = CEUtil.getValueMatch("Date:\\s[\\w|,]+([\\w|,|\\s|\\d|:]+)", contentLog);
		
		MessageLog msgLog = ceModel.createMessageLog();
		msgLog.setType(CEUtil.getMessageType(type));
		msgLog.setCreation(value);
		msgLog.setTitle(subject);
		
		
		Message msg = matchingPatterns(project, contentLog);
				
		
		
		
		
		
		msgLog.getMessages().add(msg);
		
		String modelName = chatEmailFileName.substring(0, chatEmailFileName.indexOf(".eml"));
		
		ceModel.storeModel(project, modelName, "chatlogs");
			
	}
	
	/**
	 * Extract specific information within the commit
	 * @param listOfCommits
	 */
	public Message matchingPatterns(String project, String contentLog) throws Exception {
		
		Message msg = ceModel.createMessage();
		
		String from = CEUtil.getValueMatch("From:\\s([?|\\w|\\d|=|-]+\\s<[\\w|\\d|@|.]+>)", contentLog);
		String to = CEUtil.getValueMatch("To:\\s([?|\\w|\\d|=|-|\\s]+\\s<[\\w|\\d|@|.]+>(,\\s([?|\\w|\\d|=|-|\\s]+\\s<[\\w|\\d|@|.]+>)*))", contentLog);
		String cc = CEUtil.getValueMatch("CC:\\s([?|\\w|\\d|=|-|\\s]+\\s<[\\w|\\d|@|.]+>(,\\s([?|\\w|\\d|=|-|\\s]+\\s<[\\w|\\d|@|.]+>)*))", contentLog);
		
		msg.setSentBy(from);
		msg.setReceivedBy(to);
		
		
		String boundary = CEUtil.getValueMatch("boundary=\\\"([\\\\d|\\\\w|_]+)\\\"", contentLog);
		
		
		return msg;
		
		
			
		
	}
	
}
