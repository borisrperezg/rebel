package uniandes.rebel.chatlogs;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Date;
import java.util.Properties;

import javax.mail.BodyPart;
import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;

import rebel_chatlogs.Message;
import rebel_chatlogs.MessageLog;

public class CEPopulation {

	private CEModel ceModel;

	public CEPopulation() {
		ceModel = new CEModel();
	}

	public static void main(String[] args) throws Exception {
		CEPopulation ce = new CEPopulation();
		ce.execute("AutoNuevo", "Survey Comments.eml");
		
//		display(new File("/Users/borisperezg/temporaluploadfolder/Survey Comments.eml"));
	}

	/**
	 * Executed by revelapi
	 * 
	 * @param project
	 * @param commits
	 * @throws Exception
	 */
	@SuppressWarnings("deprecation")
	public void execute(String project, String chatEmailFileName) throws Exception {

		String modelName = chatEmailFileName.substring(0, chatEmailFileName.indexOf(".eml"));
		
		ceModel.createModel(project, modelName);		
		
		String filePathName = "/Users/borisperezg/temporaluploadfolder/" + chatEmailFileName;
		
		// Temporal loaded route from web page
		String contentLog = CEUtil.readFile(filePathName);

		MessageLog msgLog = ceModel.createMessageLog();

		// ---------------
		// Type
		// ---------------
		String type = "chat";
		if (chatEmailFileName.indexOf(".eml") >= 0)
			type = "email";

		msgLog.setType(CEUtil.getMessageType(type));
		
		if(type.equals("email")) {
			// ---------------
			// Creation date
			// ---------------
			Date msgDate = null;
			// La fecha se captura asÃ­:
			// "4 Mar 2021 14:31:54 "
			String date = CEUtil.getValueMatch("Date:\\s[\\w|,]+([\\w|,|\\s|\\d|:]+)", contentLog);
			System.out.println("date = " + date);
			if (date != null && date.length() > 0) {
				String[] textualDate = date.trim().split(" ");

				System.out.println("textualDate[0] = " + textualDate[0]);
				System.out.println("textualDate[1] = " + textualDate[1]);
				System.out.println("textualDate[2] = " + textualDate[2]);

				int dayNumber = Integer.parseInt(textualDate[0]);
				String monthText = textualDate[1];
				int yearNumber = Integer.parseInt(textualDate[2]);

				msgDate = new Date(yearNumber - 1900, CEUtil.monthNumber(monthText), dayNumber);
			}

			msgLog.setCreation(msgDate);
			
			// ------------------------------
			// Get properties of email
			// ------------------------------
			getEmailProperties(msgLog, filePathName);
		}
		
		

		ceModel.storeModel(project, modelName, "chatlogs");

	}

	public void getEmailProperties(MessageLog msgLog, String emlFileName) throws Exception {
		
		// --------------------------------------
		// Bloque para instanciar EML
		// --------------------------------------
		File emlFile = new File(emlFileName);
		
		Properties props = System.getProperties();
		props.put("mail.host", "smtp.dummydomain.com");
		props.put("mail.transport.protocol", "smtp");

		Session mailSession = Session.getDefaultInstance(props, null);
		InputStream source = new FileInputStream(emlFile);
		MimeMessage message = new MimeMessage(mailSession, source);
		
		// --------------------------------------
		// Obtencion de propiedades
		// --------------------------------------
		
		msgLog.setTitle(message.getSubject());
		
		Message msg = ceModel.createMessage();
		
		msg.setSentBy(message.getFrom()[0].toString());
		msg.setReceivedBy(message.getAllRecipients()[0].toString());
		
		MimeMultipart mimeMultipart = (MimeMultipart) message.getContent();
        String result = CEUtil.getTextFromMimeMultipart(mimeMultipart);
		
        msg.setText(result);
        msg.setTimestamp(msgLog.getCreation());
        
        msgLog.getMessages().add(msg);
        
	}
	
	

}
